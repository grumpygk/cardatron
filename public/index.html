<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Card-a-tron</title>
    <script src="lib/cardatron.js"></script>
    <script src="lib/uglipop.js"></script>
    <link rel="stylesheet" type="text/css" href="css/cardatron.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script>
        function searchForCards(term, supressDuplicates, sortBy, randomCount, track, selectCardText, invert) {
            var resultsElement = document.getElementById("results");
            var selectCardsElement = document.getElementById("selectedCards");

            let minLength = getMinSearchLength();

            var drawnCards = getArrayFromDelimitedText(selectCardText,",");

            if (term.length >= minLength) {
                let results = search(term, supressDuplicates, sortBy, randomCount, (selectCardText != undefined ? drawnCards : []), invert);

                if(track == true) {
                    drawnCards = getCardIds(results).concat(drawnCards);
                    selectCardsElement.value = drawnCards.filter(Boolean).join(",");
                }
                
                if (results.length > 0) {
                    resultsElement.innerHTML = makeHtml(results);
                } else {
                    resultsElement.innerHTML = "<div>No match found</div>";
                }
            } else {
                element.innerHTML = "<div>Search term must be at least " + minLength + " characters</div>";
            }
        }

        function nthIndex(str, pat, n){
            var l = str.length, i= -1;
            while(n-- && i++<l){
                i= str.indexOf(pat, i);
                if (i < 0) break;
            }
            return i;
        }   
        
        function getRandomCards(term, excludeDuplicates, sortBy, count, track, selectCardText, redraw) {
            if(track == true) {
                
                if(redraw == true) {                    
                    let cut = nthIndex(selectCardText, ",", count); 

                    selectCardText = cut > 0 ? selectCardText.slice(cut) : "";
                }
                
                searchForCards(term, excludeDuplicates, sortBy, count, track, selectCardText);
            } else {
                searchForCards(term, excludeDuplicates, sortBy, count);
            }
        }

        function showExcludedCards(term, suppressDuplicates, sortBy, drawn){
            searchForCards(term, suppressDuplicates, sortBy, undefined, undefined, drawn, true);
        }

        function showRemaingCards(term, suppressDuplicates, sortBy, drawn){
            searchForCards(term, suppressDuplicates, sortBy, undefined, undefined, drawn);
        }

        function clearTrack() {
            var selectCardsElement = document.getElementById("selectedCards");
            selectCardsElement.value = "";
        }

        function makeHtml(cards) {

            var template = "<div title=\"{title}\" class=\"{class}\" style=\"background-image: url('{image}')\"  onclick=\"onImageClick('{image}')\"></div>";

            var lastCard = null;

            var html = "";
            var extraClass = "";

            for (card of cards) {

                if (lastCard == undefined || (lastCard.grouping != card.grouping)) {
                    extraClass = " clear";
                } else {
                    extraClass = "";
                }

                html += template.replace("{title}", card.toolTip).replace("{class}", card.size + extraClass).replace("{image}", card.url).replace("{image}", card.url);

                lastCard = card;
            }

            return html;
        }

        function getSortingOptions(sortInfo) {

            var template = "<option {selected} value=\"{value}\">{name}</option>\n";
            let html="";

            for(index in sortInfo.sorters) {
                html += template.replace("{selected}", sortInfo.sorters[index] == sortInfo.default ? "selected":"")
                .replace("{value}", sortInfo.sorters[index])
                .replace("{name}", sortInfo.sorters[index]);
            }

            return html;
        }
        
        function getSelectedSort() {
            var sortElement = document.getElementById("sort");
            return sortElement.options[sortElement.selectedIndex].value;
        }
        
    </script>

</head>

<body>
    <script>var pageInit = function () {
            var element = document.getElementById("title");
            element.innerHTML = getTitle();

            var sort = document.getElementById("sort");
            
            let sortInfo = getSortInfo();
            sort.innerHTML= getSortingOptions(sortInfo);

            if(sortInfo.show != true) {
                var sortLabel = document.getElementById("sortLabel");
                sort.style.visibility = "hidden";
                sort.style.visibility = "hidden";
            }

        }
    </script>

    <script>var onImageClick = function (imageUrl) {
            var temp = '<img class="popup" src="' + imageUrl + '" />'
            uglipop({ class: 'put', source: 'html', content: temp });
        }
    </script>

    <h3 id="title">Card-a-tron!</h3>
    <input type="text" placeholder="Search.." id="term" size="50">
    <button id="doSearch" onclick="searchForCards(term.value.trim(), excludeDuplicates.checked, getSelectedSort())"><i class="fa fa-search"></i></button>
    <input type="checkbox" id="excludeDuplicates">
    <label for="excludeDuplicates">Exclude Duplicates</label>    
    <label id="sortLabel" style="padding-left:15px" for="sort">Sort:</label>
    <select id="sort"></select>
    <span style="padding-left:20px"></span>
    <div style="margin-bottom:3px;"></div>
    <button id="doRandom" onclick="getRandomCards(term.value.trim(), excludeDuplicates.checked, getSelectedSort(), count.value.trim(), track.checked, selectedCards.value)"><i class="fa fa-random"></i></button>
    <input type="text" placeholder="#" id="count" size="5" value="1">    
    <span style="padding-left:5px"></span>
    <button id="doRedrawRandom" onclick="getRandomCards(term.value.trim(), excludeDuplicates.checked, getSelectedSort(), count.value.trim(), track.checked, selectedCards.value, true)"><i class="fa fa-repeat"></i></button>
    <label style="padding-left:5px" for="track">Track</label>
    <input type="checkbox" id="track">    
    <input style="padding-left:5px" type="text" placeholder="Cards Drawn..." id="selectedCards" size="100">
    <button id="clearTrack" onclick="clearTrack()"><i class="fa fa-times"></i></button>
    <button id="doSearchExcluded" onclick="showExcludedCards(term.value.trim(), excludeDuplicates.checked, getSelectedSort(), selectedCards.value)"><i class="fa fa-align-left"></i></button>
    <button id="doSearchRemaining" onclick="showRemaingCards(term.value.trim(), excludeDuplicates.checked, getSelectedSort(), selectedCards.value)"><i class="fa fa-align-right"></i></button>
    <div style="margin-bottom:15px;"></div>
    <div id="results"></div>

</body>

<script>
    document.getElementById("term").addEventListener("keyup", function (event) {
        event.preventDefault();
        if (event.keyCode === 13) {
            document.getElementById("doSearch").click();
        }
    });

    document.getElementById("count").addEventListener("keyup", function (event) {
        event.preventDefault();
        if (event.keyCode === 13) {
            document.getElementById("doRandom").click();
        }
    });

</script>

</html>